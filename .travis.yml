language: node_js

services:
  - docker

node_js: "8"

install:
  - yarn

jobs:
  include:
    - stage: test
      script:
        - >-
          yarn stylelint
          && yarn test
          && yarn build-dev-css
          && yarn build-storybook

    - stage: deploy storybook
      script:
        - >-
          yarn prepare-prod-resources
          && yarn build-storybook
          && ./deploy-storybook.sh
      if: branch = master AND NOT tag IS present

    - stage: build library and deploy
      script:
        - yarn build-lib
      before_deploy:
        - ls -1
      deploy:
        - provider: npm
          email: $NPM_EMAIL
          api_key: $NPM_API_KEY
          skip_cleanup: true
          on:
            tags: true
            repo: keboola/indigo-ui
            branch: master
      if: tag IS present

cache: yarn

notifications:
  slack:
    secure: HPdglG/ZqDe5PPaPbVikxj4kP3UDEf2ppQeQMCRgHbCDRZv80iRiQfYYSsNa7SOWVGT1+xM2k6kfS5+dCCYfTw7OMofX8t9SytPUrgjnQ3HNIx9XGSy2F9UYTG5gh7PbiEZuteey0+DwpJATdbqX56ThH7wBQTVxisHDzURnKPdTyCF9ydUeGns0lrBpDMgqO5QWUftB4OdxBZH9za4C9AiELrL7aHGy0FFuqFmO+g7/j9ScI6qPilre8BpYPlf3RhynfADeB5/afBoR11l6Z5bwhtNDu1UUgveYcWoY9pklmPYwuLA+9dtTVF1PtFo6sWPMP7xUj7fNYDVgRPLxh6KHEmpIjX8TCNWtspg+W9KHTHsL10+ltrI2hcuwMNwanQGef7JUMkhHc1bxSB5Ady/6KJQHiPBFhXiFckS/n0tt6N8pHz/1ugX8rqiFBV22uwPK2SLadOOgFpGez2IBGgQyCzrKKYgjxN1JRa3tZB558S1gshlokefwu0dSUYDePEh+P+NYkmK/3HB/nlgrD3D0LYcMo79NQTE3DB8LnwG5It6u4XhOMBSVMtVT/i2EkqPikxlZtFE+CZhG+u7yU5b78EvPRPRa4VEnLrHba/OJ0XczwpYfoWBHssWIMgc3LGECQ9qbDxAaPrnT/HCnHif8dVgj9t4OKU2n27PBFKE=
  email: false
